name: 'ä½¿ç”¨ Buildozer æ„å»º Android APK'

on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build:
    name: æ„å»º APK
    runs-on: ubuntu-22.04  # ä½¿ç”¨æ›´ç¨³å®šçš„ Ubuntu ç‰ˆæœ¬ï¼Œé¿å…å…¼å®¹æ€§é—®é¢˜

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v2

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          architecture: x64
          python-version: 3.8  # å¯æ ¹æ®é¡¹ç›®éœ€è¦è°ƒæ•´

      - name: â˜• å®‰è£… Java 17ï¼ˆGradle æ‰€éœ€ï¼‰
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ§­ è®¾ç½® JAVA_HOME ç¯å¢ƒå˜é‡
        run: echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV

      - name: ğŸ› ï¸ å®‰è£…ç³»ç»Ÿä¾èµ–é¡¹ + Buildozer
        run: |
          sudo apt update
          sudo apt install -y git \
            zip \
            unzip \
            openjdk-17-jdk \
            python3-pip \
            autoconf \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libtinfo6 \  # æ›¿ä»£ libtinfo5ï¼Œé€‚é… Ubuntu 22.04+
            cmake \
            libffi-dev \
            libssl-dev
          python3 -m pip install --upgrade pip
          python3 -m pip install --upgrade \
            Cython==0.29.33 \
            buildozer

      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–ï¼ˆå¦‚æœå­˜åœ¨ requirements.txtï¼‰
        run: |
          if [ -f requirements.txt ]; then
            python3 -m pip install -r requirements.txt
          fi

      - name: ğŸ’¾ ç¼“å­˜ Buildozer å’Œ Gradle æ„å»ºç›®å½•
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer
            ~/.gradle
          key: ${{ runner.os }}-buildozer-${{ hashFiles('**/*.py') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-

      - name: ğŸ”¨ ä½¿ç”¨ Buildozer æ„å»º APK
        run: |
          buildozer android debug

      # ï¼ˆå¯é€‰ï¼‰ä¸Šä¼  APK åˆ° GitHub Actions çš„æ„å»ºäº§ç‰©
      - name: ğŸ“¤ ä¸Šä¼  APK æ–‡ä»¶
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: bin/*.apk
