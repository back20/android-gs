name: Build Signed APK

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_SDK_ROOT: /home/runner/android-sdk
      ANDROID_NDK_ROOT: /home/runner/android-sdk/ndk/21.4.7075529
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
    - name: 检出项目代码
      uses: actions/checkout@v3

    - name: 安装依赖（包括构建工具）
      run: |
        sudo apt update
        sudo apt install -y build-essential ccache git zip unzip openjdk-17-jdk \
          autoconf automake libtool pkg-config
        pip install --upgrade pip
        pip install buildozer cython

    - name: 解码 Keystore（签名密钥）
      run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > my-release-key.keystore

    - name: 验证 SDK 和 NDK 目录
      run: |
        echo "SDK Path: $ANDROID_SDK_ROOT"
        ls -l $ANDROID_SDK_ROOT
        echo "NDK Path: $ANDROID_NDK_ROOT"
        ls -l $ANDROID_NDK_ROOT

    - name: 构建 Release APK（自动签名）
      run: |
        buildozer android release \
          --ndk $ANDROID_NDK_ROOT \
          --keystore my-release-key.keystore \
          --keystore-password $KEYSTORE_PASSWORD \
          --keyalias WorkTimeKey \
          --keyalias-password $KEY_PASSWORD

    - name: 上传已签名 APK
      uses: actions/upload-artifact@v4
      with:
        name: signed-apk
        path: bin/*.apk
