name: Build APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release_type:
        description: '构建类型'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: 步骤 1/12 - 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 步骤 2/12 - 设置 Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: 步骤 3/12 - 缓存依赖
      uses: actions/cache@v4
      with:
        path: |
          ~/.buildozer
          ~/.cache/pip
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    - name: 步骤 4/12 - 安装 Buildozer
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython

    - name: 步骤 5/12 - 设置 Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: 步骤 6/12 - 安装 Android SDK
      uses: malinskiy/action-android/install-sdk@release/0.1.6

    - name: 步骤 7/12 - 安装必要的 Android 构建工具
      run: |
        # 安装最新的 build-tools 和平台
        echo "安装 build-tools 和平台..."
        /home/runner/android-sdk/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.2"
        /home/runner/android-sdk/cmdline-tools/latest/bin/sdkmanager "platforms;android-33"
        /home/runner/android-sdk/cmdline-tools/latest/bin/sdkmanager "ndk;25.2.9519653"
        
        # 接受所有许可证
        echo "接受 Android SDK 许可证..."
        yes | /home/runner/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses

    - name: 步骤 8/12 - 创建符号链接以匹配 Buildozer 期望的路径
      run: |
        # 创建 Buildozer 期望的 SDK 目录结构
        mkdir -p /home/runner/.buildozer/android/platform/
        ln -s /home/runner/android-sdk /home/runner/.buildozer/android/platform/android-sdk
        
        # 创建 sdkmanager 工具的符号链接
        mkdir -p /home/runner/.buildozer/android/platform/android-sdk/tools/bin/
        ln -s /home/runner/android-sdk/cmdline-tools/latest/bin/sdkmanager /home/runner/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager
        
        # 验证符号链接
        echo "符号链接验证:"
        ls -la /home/runner/.buildozer/android/platform/android-sdk/tools/bin/

    - name: 步骤 9/12 - 配置 Buildozer.spec
      run: |
        if [ ! -f buildozer.spec ]; then
          buildozer init
        fi
        
        # 基础配置
        sed -i 's/title = My Application/title = 工时价格Excel生成器/g' buildozer.spec
        sed -i 's/package.name = myapp/package.name = gzexcel/g' buildozer.spec
        sed -i 's/package.domain = org.test/package.domain = com.example/g' buildozer.spec
        sed -i 's/requirements = python3,kivy/requirements = python3,kivy,kivymd,pandas,openpyxl/g' buildozer.spec
        sed -i 's/source.main = main.py/source.main = gz.py/g' buildozer.spec
        
        # 明确指定 build-tools 版本
        echo "android.build_tools_version = 33.0.2" >> buildozer.spec
        
        # 根据构建类型调整配置
        if [ "${{ github.event.inputs.release_type }}" == "release" ]; then
          echo "配置发布版本构建..."
          sed -i '/android.permissions =/c\android.permissions = INTERNET, WRITE_EXTERNAL_STORAGE, READ_EXTERNAL_STORAGE' buildozer.spec
          echo "android.keystore = True" >> buildozer.spec
          echo "android.keystore.password = \$ENV{KEYSTORE_PASSWORD}" >> buildozer.spec
          echo "android.keystore.alias = \$ENV{KEY_ALIAS}" >> buildozer.spec
          echo "android.keystore.alias.password = \$ENV{KEY_PASSWORD}" >> buildozer.spec
        else
          echo "配置调试版本构建..."
        fi

    - name: 步骤 10/12 - 设置 Android 环境变量
      run: |
        # 设置环境变量
        echo "ANDROID_HOME=/home/runner/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=/home/runner/android-sdk" >> $GITHUB_ENV
        echo "PATH=$PATH:/home/runner/android-sdk/cmdline-tools/latest/bin:/home/runner/android-sdk/platform-tools" >> $GITHUB_ENV

    - name: 步骤 11/12 - 构建 APK
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        BUILDTOOLS_VERSION: 33.0.2  # 指定 build-tools 版本
      run: |
        # 打印环境变量和目录结构用于调试
        echo "===== 环境变量 ====="
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        echo "PATH: $PATH"
        
        echo "===== SDK 目录结构 ====="
        echo "SDK 根目录内容:"
        ls -la $ANDROID_SDK_ROOT
        
        echo "sdkmanager 路径验证:"
        which sdkmanager
        ls -la /home/runner/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager
        
        echo "build-tools 目录内容:"
        ls -la $ANDROID_SDK_ROOT/build-tools
        
        echo "build-tools;33.0.2 目录内容:"
        ls -la $ANDROID_SDK_ROOT/build-tools/33.0.2
        
        # 验证 aidl 工具是否存在
        echo "===== aidl 工具验证 ====="
        if [ -f "$ANDROID_SDK_ROOT/build-tools/33.0.2/aidl" ]; then
          echo "aidl 工具存在"
        else
          echo "aidl 工具不存在，构建可能失败"
        fi
        
        # 准备签名密钥（仅发布版本需要）
        if [ "${{ github.event.inputs.release_type }}" == "release" ]; then
          echo "准备签名密钥..."
          echo "$KEYSTORE_BASE64" | base64 -d > release.keystore
          mkdir -p ~/.buildozer/android/platform/
          mv release.keystore ~/.buildozer/android/platform/
        fi
        
        # 设置内存限制
        export GRADLE_OPTS="-Xmx4g -Xms1g"
        
        # 执行构建
        if [ "${{ github.event.inputs.release_type }}" == "release" ]; then
          echo "开始构建签名 APK..."
          buildozer -v android release
        else
          echo "开始构建调试 APK..."
          buildozer -v android debug
        fi

    - name: 输出构建结果
      id: output
      run: |
        APK_PATH=$(find bin -name "*-${{ github.event.inputs.release_type }}.apk" | head -1)
        echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
        
        VERSION=$(grep "version = " buildozer.spec | cut -d'=' -f2 | tr -d ' ')
        echo "VERSION=${VERSION:-unknown}" >> $GITHUB_ENV
        
        COMMIT_MSG=$(git log -1 --pretty=%B)
        echo "COMMIT_MSG=$COMMIT_MSG" >> $GITHUB_ENV

    - name: 上传 APK 构建产物
      uses: actions/upload-artifact@v4
      with:
        name: 工时价格Excel生成器_v${{ env.VERSION }}_${{ github.sha }}
        path: ${{ env.APK_PATH }}
        retention-days: 30

    - name: 构建完成摘要
      run: |
        echo "========================================"
        echo " 构建完成!"
        echo "----------------------------------------"
        echo " 构建类型: ${{ github.event.inputs.release_type }}"
        echo " 版本号: v${{ env.VERSION }}"
        echo " 提交哈希: ${{ github.sha }}"
        echo " 提交信息: ${{ env.COMMIT_MSG }}"
        echo " APK 路径: ${{ env.APK_PATH }}"
        echo "========================================"
